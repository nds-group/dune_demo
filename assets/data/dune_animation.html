<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>DUNE animation</title>
   <style>
      /* set colors as vars */
      :root {
         --red: #ff6c6c;
         --blue: #7777fa;
         --green: #78ff78;
         --orange: #fccf7c;
         --class-A: var(--red);
         --class-B: var(--blue);
         --class-C: var(--green);
         --class-D: var(--orange);
      }

      body {
         font-family: sans-serif;
         background-color: transparent;
         padding: 20px;
         overflow-x: hidden;
      }

      h1 {
         text-align: center;
         color: #ddd;
      }

      .network-diagram {
         position: relative;
         max-width: 950px;
         /* Ajustado para el ancho del SVG */
         margin: 40px auto;
         padding: 20px 0;
         /* Damos altura explícita para contener el SVG y animaciones */
         min-height: 300px;
      }

      #network-svg {
         display: block;
         margin: 0 auto;
         max-width: 100%;
         height: auto;
         overflow: visible;
      }

      #cable-layer path {
         fill: none;
         stroke-linecap: round;
      }

      .packet {
         /* Tamaño inicial del paquete */
         r: 5;
         /* Color inicial antes de clasificación */
         fill: #fff;
         stroke: #333;
         stroke-width: 1;
         /* Transición suave para el cambio de color */
         transition: all 0.1s ease;
      }

      .packet.classified-A {
         fill: #ff6c6c;
         /* Rojo */
      }

      .packet.classified-B {
         fill: #7777fa;
         /* Azul */
      }

      .packet.classified-C {
         fill: #78ff78;
         /* Verde */
      }

      .packet.classified-D {
         fill: #fccf7c;
         /* Naranja */
      }

      #svg-definitions {
         position: absolute;
         width: 0;
         height: 0;
         overflow: hidden;
      }
   </style>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>

<body>

   <h1>DUNE example</h1>
   <!-- Contenedor Principal -->
   <div class="network-diagram">

      <?xml version="1.0" encoding="UTF-8" standalone="no"?>
      <svg width="897.83679" height="245.02551" viewBox="0 0 897.83679 245.02551"
         aria-labelledby="diagramTitle diagramDesc" version="1.1" id="svg10" sodipodi:docname="switch.svg"
         inkscape:version="1.4 (e7c3feb100, 2024-10-09)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
         xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:cc="http://creativecommons.org/ns#"
         xmlns:dc="http://purl.org/dc/elements/1.1/">
         <sodipodi:namedview id="namedview10" pagecolor="#ffffff" bordercolor="#000000" borderopacity="0.25"
            inkscape:showpageshadow="2" inkscape:pageopacity="0.0" inkscape:pagecheckerboard="0"
            inkscape:deskcolor="#d1d1d1" showgrid="false" inkscape:zoom="1.16125" inkscape:cx="345.74812"
            inkscape:cy="124.43488" inkscape:window-width="1920" inkscape:window-height="1008" inkscape:window-x="0"
            inkscape:window-y="0" inkscape:window-maximized="1" inkscape:current-layer="layer2" />
         <defs id="defs7">
            <linearGradient id="swatch11" inkscape:swatch="solid">
               <stop style="stop-color:#acacac;stop-opacity:1;" offset="0" id="stop11" />
            </linearGradient>
            <symbol id="animated-switch-symbol" viewBox="0 0 180 70">
               <title id="title1">Switch</title>
               <!-- Estilos -->
               <style id="style1">
                  @keyframes blinkSlowAnim {

                     0%,
                     100% {
                        fill: #00ff00;
                     }

                     50% {
                        fill: #333300;
                     }
                  }

                  @keyframes blinkFastAnim {

                     0%,
                     100% {
                        fill: #00ff00;
                     }

                     50% {
                        fill: #333300;
                     }
                  }

                  .led-slow {
                     animation: blinkSlowAnim 1.5s infinite;
                  }

                  .led-fast {
                     animation: blinkFastAnim 0.5s infinite;
                  }

                  .switch-body {
                     fill: #535353;
                     stroke: #afafaf;
                     stroke-width: 1;
                  }

                  .port {
                     fill: #282828;
                     stroke: #555;
                     stroke-width: 0.5;
                  }

                  .led {
                     /* Estilos base del LED */
                  }

                  .led-on {
                     fill: #00ff00;
                  }

                  .led-off {
                     fill: #333300;
                  }

                  .label-text {
                     font-family: Arial, sans-serif;
                     font-size: 10px;
                     fill: #e9e8e8;
                     text-anchor: start;
                  }
               </style>
               <!-- Cuerpo principal del switch -->
               <rect class="switch-body" x="5" y="10" width="170" height="50" rx="4" ry="4" id="rect1" />
               <!-- Zona de puertos y LEDs -->
               <g id="symbol-port-area">
                  <!-- LEDs -->
                  <circle class="led led-on" cx="27.5" cy="20" r="2.5" id="circle1" />
                  <!-- Puerto 1 -->
                  <circle class="led led-off" cx="47.5" cy="20" r="2.5" id="circle2" />
                  <!-- Puerto 2 -->
                  <circle class="led led-off" cx="67.5" cy="20" r="2.5" id="circle3" />
                  <!-- Puerto 3 -->
                  <circle class="led led-on" cx="87.5" cy="20" r="2.5" id="circle4" />
                  <!-- Puerto 4 -->
                  <!-- Puertos RJ45 -->
                  <rect class="port" x="20" y="28" width="15" height="22" rx="1.5" ry="1.5" id="rect4" />
                  <rect class="port" x="40" y="28" width="15" height="22" rx="1.5" ry="1.5" id="rect5" />
                  <rect class="port" x="60" y="28" width="15" height="22" rx="1.5" ry="1.5" id="rect6" />
                  <rect class="port" x="80" y="28" width="15" height="22" rx="1.5" ry="1.5" id="rect7" />
               </g>
               <!-- Etiqueta del switch dentro del símbolo -->
               <g id="symbol-label-area">
                  <text class="label-text" x="115" y="40" id="text7">SwitchP4</text>
               </g>
            </symbol>
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient11" x1="-41.931332"
               y1="41.009075" x2="84.185104" y2="41.009075" gradientUnits="userSpaceOnUse" />
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient12"
               gradientUnits="userSpaceOnUse" x1="-41.931332" y1="41.009075" x2="84.185104" y2="41.009075"
               gradientTransform="translate(-20.667384,6.0279871)" />
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient13"
               gradientUnits="userSpaceOnUse" gradientTransform="translate(-19.223114,69.488021)" x1="-41.931332"
               y1="41.009075" x2="84.185104" y2="41.009075" />
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient14"
               gradientUnits="userSpaceOnUse" gradientTransform="translate(241.70261,66.904598)" x1="-41.931332"
               y1="41.009075" x2="84.185104" y2="41.009075" />
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient15"
               gradientUnits="userSpaceOnUse" gradientTransform="translate(238.53606,4.3057051)" x1="-41.931332"
               y1="41.009075" x2="84.185104" y2="41.009075" />
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient16"
               gradientUnits="userSpaceOnUse" gradientTransform="translate(518.40689,3.4445641)" x1="-41.931332"
               y1="41.009075" x2="84.185104" y2="41.009075" />
            <linearGradient inkscape:collect="always" xlink:href="#swatch11" id="linearGradient17"
               gradientUnits="userSpaceOnUse" gradientTransform="translate(497.7395,2.5834231)" x1="-41.931332"
               y1="41.009075" x2="84.185104" y2="41.009075" />
         </defs>
         <g id="switch-layer" transform="translate(41.931325,3.8892291)" sodipodi:insensitive="true">
            <!-- Instancia Switch A -->
            <g id="switch-a" transform="translate(50,40)">
               <use href="#animated-switch-symbol" width="180" height="70" id="use7" style="fill:#666666" />
               <!-- Etiqueta específica para esta instancia -->
               <text x="90" y="-10" text-anchor="middle" font-family="Arial, sans-serif" font-size="12px" fill="#ddd"
                  id="switch-label-a" data-name="Switch A">Switch A</text>
               <text x="90" y="2" text-anchor="middle" font-family="Arial, sans-serif" font-size="12px" fill="#ddd"
                  id="status-label-a" data-name="Switch A">Forwarding</text>
            </g>
            <!-- Instancia Switch B -->
            <g id="switch-b" transform="translate(310,40)">
               <use href="#animated-switch-symbol" width="180" height="70" id="use8" />
               <!-- Etiqueta específica para esta instancia -->
               <text x="90" y="-10" text-anchor="middle" font-family="Arial, sans-serif" font-size="12px" fill="#ddd"
                  id="switch-label-b" data-name="Switch B">Switch B</text>
               <text x="90" y="2" text-anchor="middle" font-family="Arial, sans-serif" font-size="12px" fill="#ddd"
                  id="status-label-b" data-name="Switch A">Forwarding</text>
            </g>
            <!-- Instancia Switch C -->
            <g id="switch-c" transform="translate(570,40)">
               <use href="#animated-switch-symbol" width="180" height="70" id="use9" />
               <!-- Etiqueta específica para esta instancia -->
               <text x="90" y="-10" text-anchor="middle" font-family="Arial, sans-serif" font-size="12px" fill="#ddd"
                  id="switch-label-c" data-name="Switch C">Switch C</text>
               <text x="90" y="2" text-anchor="middle" font-family="Arial, sans-serif" font-size="12px" fill="#ddd"
                  id="status-label-c" data-name="Switch A">Forwarding</text>
            </g>
         </g>
         <g inkscape:groupmode="layer" id="layer1" inkscape:label="Cable layer"
            transform="translate(41.931325,3.8892291)" sodipodi:insensitive="true">
            <path
               style="opacity:0.9;fill:none;fill-opacity:1;stroke:url(#linearGradient13);stroke-width:8;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none;stroke-opacity:1;paint-order:fill markers stroke"
               d="m 336.42813,80.110771 c -96.12434,28.911029 -197.2013,0 -197.2013,0" id="cable-a-b"
               inkscape:label="CableA-B" sodipodi:nodetypes="cc" />
            <path
               style="opacity:0.9;fill:none;fill-opacity:1;stroke:url(#linearGradient11);stroke-width:8;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none;stroke-opacity:1;paint-order:fill markers stroke"
               d="m -59.663527,-10.812787 c 0.684884,73.779048 80.533901,89.416242 137.732202,90.923558" id="cable-0"
               inkscape:label="Cable0" sodipodi:nodetypes="ccc" />
            <path
               style="opacity:0.9;fill:none;fill-opacity:1;stroke:url(#linearGradient14);stroke-width:8;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none;stroke-opacity:1;paint-order:fill markers stroke"
               d="m 597.35386,80.110771 c -96.12434,28.911029 -197.2013,0 -197.2013,0" id="cable-b-c"
               inkscape:label="CableB-C" sodipodi:nodetypes="cc" />
            <path
               style="opacity:0.9;fill:none;fill-opacity:1;stroke:url(#linearGradient16);stroke-width:8;stroke-linecap:round;stroke-linejoin:round;stroke-dasharray:none;stroke-opacity:1;paint-order:fill markers stroke;marker-end:url(#Square)"
               d="m 858.06867,191.11077 h -170 c -30.70975,0 -31.00775,-2.22373 -30,-110.999999" id="cable-d-out"
               inkscape:label="CableD-out" sodipodi:nodetypes="cssc" />
         </g>
         <g inkscape:groupmode="layer" id="layer2" inkscape:label="PackagePath">
            <path
               style="opacity:0;fill:none;fill-opacity:1;stroke:#ff8916;stroke-width:7.55906;stroke-linecap:square;stroke-linejoin:round;stroke-dasharray:none;stroke-opacity:0.581339;paint-order:fill markers stroke"
               d="m -20.703234,-8.1783733 c 0,0 2.700242,57.0377453 60.109076,78.0676993 45.357179,16.615202 97.410288,15.284852 120.063318,14.124903 30.52337,-1.562951 66.5507,13.609606 130.97861,12.506562 53.47411,-0.915507 58.18077,-6.899692 88.64104,-11.823772 38.5268,-6.228083 51.93637,-3.540813 91.97809,5.742991 51.54736,11.95143 125.22127,6.726674 172.47677,-7.433216 5.13454,-1.53854 14.6682,2.820267 24.32593,-2.729014 18.986,-10.909253 19.35156,-44.178913 26.39407,-42.3379 9.58364,2.5053 5.84785,50.795438 5.84785,59.582036 0,101.303614 -1.62452,97.615654 40.68643,97.615654 64.17377,0 157.11118,-0.45036 157.11118,-0.45036"
               id="path-class-D" inkscape:label="classD" sodipodi:nodetypes="csssssssc" />
         </g>

         <!-- Capa para los paquetes animados (DEBE ESTAR DESPUÉS para verse encima) -->
         <g id="packet-layer" transform="translate(0,0)">
            <!-- Los paquetes se añadirán aquí dinámicamente -->
         </g>
      </svg>
   </div>

   <script>
      document.addEventListener('DOMContentLoaded', function () {

         const svg = document.getElementById('network-svg');
         const packetLayer = document.getElementById('packet-layer');
         const NS = "http://www.w3.org/2000/svg";

         const packetClasses = ['A', 'B', 'C'];
         const packetDistributionConfig = {
            'A': 40,
            'B': 30,
            'C': 30,
            //'D': 20
         };
         const animationDuration = 12000;
         const minInterval = 800;
         const maxInterval = 1200;
         const packetHeight = 12;
         const minPacketWidth = 15;
         const maxPacketWidth = 35;
         const hideZones = [
            { switch: 'switch-a', entryProgress: 16.5, exitProgress: 22 },
            { switch: 'switch-b', entryProgress: 39, exitProgress: 45 },
            { switch: 'switch-c', entryProgress: 62.2, exitProgress: 73.5 }
         ];

         const classConfig = {
            'A': {
               pathId: 'path-class-D',
               switchId: 'switch-a',
               classificationProgress: 21,
               colorClass: 'classified-A',
               hideZones: hideZones,
               labelId: 'status-label-a'
            },
            'B': {
               pathId: 'path-class-D',
               switchId: 'switch-b',
               classificationProgress: 43,
               colorClass: 'classified-B',
               hideZones: hideZones,
               labelId: 'status-label-b'
            },
            'C': {
               pathId: 'path-class-D',
               switchId: 'switch-c',
               classificationProgress: 63,
               colorClass: 'classified-C',
               hideZones: hideZones,
               labelId: 'status-label-c'
            },
            'D': {
               pathId: 'path-class-D',
               switchId: 'switch-c',
               classificationProgress: 63,
               colorClass: 'classified-D',
               hideZones: hideZones,
               labelId: 'status-label-c'
            }
         };

         function getRandomClassWithDistribution() {
            const rand = Math.random() * 100;
            let cumulativePercentage = 0;

            // Verifica que los porcentajes sumen (aproximadamente) 100 - opcional pero recomendado
            const totalPercentage = Object.values(packetDistributionConfig).reduce((sum, p) => sum + p, 0);
            if (Math.abs(totalPercentage - 100) > 0.1) { // Permitir un pequeño margen de error
               console.warn("¡Los porcentajes de distribución de paquetes no suman 100!");
               // Fallback a la distribución uniforme si la configuración es incorrecta
               return packetClasses[Math.floor(Math.random() * packetClasses.length)];
            }

            // Itera a través de la configuración para determinar la clase
            for (const packetClass in packetDistributionConfig) {
               cumulativePercentage += packetDistributionConfig[packetClass];
               if (rand < cumulativePercentage) {
                  return packetClass; // Devuelve la clase si el número aleatorio cae en su rango
               }
            }

            // Fallback (si hay problemas de redondeo muy cerca de 100, devuelve la última clase)
            const classes = Object.keys(packetDistributionConfig);
            return classes[classes.length - 1];
         }


         function getRandomClass() {
            return packetClasses[Math.floor(Math.random() * packetClasses.length)];
         }

         function createAndAnimatePacket() {
            const packetClass = getRandomClassWithDistribution();
            const config = classConfig[packetClass];
            const pathElement = document.getElementById(config.pathId);

            if (!pathElement) {
               console.error(`Path con ID ${config.pathId} no encontrado.`);
               scheduleNextPacket();
               return;
            }

            const packet = document.createElementNS(NS, 'rect');
            const randomWidth = minPacketWidth + Math.random() * (maxPacketWidth - minPacketWidth);

            packet.setAttribute('class', 'packet');
            packet.setAttribute('width', randomWidth);
            packet.setAttribute('height', packetHeight);
            packet.setAttribute('rx', packetHeight / 2);
            packet.setAttribute('ry', packetHeight / 2);
            packet.setAttribute('x', -randomWidth / 2);
            packet.setAttribute('y', -packetHeight / 2);
            packet.style.opacity = '1';

            packet.dataset.classified = 'false';
            packet.dataset.packetClass = packetClass;

            packetLayer.appendChild(packet);

            const motionPath = anime.path(pathElement);

            anime({
               targets: packet,
               translateX: motionPath('x'),
               translateY: motionPath('y'),
               rotate: motionPath('angle'),
               easing: 'linear',
               duration: animationDuration,
               loop: false,
               update: function (anim) {
                  // --- Lógica de actualización ---
                  const currentProgress = anim.progress;
                  if (!anim.animatables[0] || !anim.animatables[0].target) return;

                  const packetElement = anim.animatables[0].target;
                  const pClass = packetElement.dataset.packetClass;
                  const classConf = classConfig[pClass];

                  const label = document.getElementById(classConf.labelId);
                  // 0. Change Switch status label if is clasifing the package
                  if (currentProgress >= classConf.hideZones.filter(zone => zone.switch === classConf.switchId)[0].entryProgress
                     && currentProgress < classConf.hideZones.filter(zone => zone.switch === classConf.switchId)[0].exitProgress) {

                     if (label) {
                        label.textContent = 'Inferring...';
                        //label.setAttribute('fill', 'var(--class-' + pClass + ')');
                        // set the text bold
                        label.setAttribute('font-weight', 'bold');
                     }

                     if (packetElement.dataset.classified === 'false') {
                        packetElement.dataset.classified = 'true';
                        packetElement.classList.add(classConf.colorClass);
                     }

                  } else if (packetElement.dataset.classified === 'true'
                     && currentProgress >= classConf.hideZones.filter(zone => zone.switch === classConf.switchId)[0].exitProgress) {

                     if (label) {
                        label.textContent = 'Forwarding';
                        label.removeAttribute('font-weight');
                        label.setAttribute('font-weight', 'normal');

                     }
                  }
                  
                  // --- Switch Label Logic ---
                  let isInsideSwitch = false;
                  if (classConf.hideZones && classConf.hideZones.length > 0) {
                     for (const zone of classConf.hideZones) {
                        if (currentProgress >= zone.entryProgress && currentProgress < zone.exitProgress) {
                           isInsideSwitch = true;
                           break; // Encontrado dentro de una zona, no necesita verificar más
                        }
                     }
                  }

                  // Aplicar visibilidad basado en si está dentro de una zona o no
                  packetElement.style.opacity = isInsideSwitch ? '0' : '1';

               },
               complete: function (anim) {
                  if (anim.animatables[0] && anim.animatables[0].target) {
                     anim.animatables[0].target.remove();
                  }
               }
            });

            scheduleNextPacket();
         }

         function scheduleNextPacket() {
            // only schedule next packet if the amount of animated packages is less than 15

            const animatedPackets = packetLayer.querySelectorAll('g');
            if (animatedPackets.length >= 15) {
               console.warn("Demasiados paquetes animados (" + animatedPackets.length + "). Esperando...");
               setTimeout(scheduleNextPacket, 1000);
               return;
            }

            const randomInterval = minInterval + Math.random() * (maxInterval - minInterval);
            setTimeout(createAndAnimatePacket, randomInterval);
         }

         // --- Iniciar la simulación ---
         createAndAnimatePacket();

      });
   </script>



</body>

</html>